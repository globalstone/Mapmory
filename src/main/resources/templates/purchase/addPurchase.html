<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
	<meta charset="UTF-8" name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width">
	<title>결제하기</title>
	
	<link rel="stylesheet" href="/css/5/cosmo/bootstrap.css"> <!-- Bootstrap watch min.css -->
	<link rel="stylesheet" href="/css/common/footer.css">
	
	<style>
		.change-color{
			background-color: #03c75a;
			color: #fff;
		}
	</style>
	
	<script src="/javascript/config/key.js"></script> <!-- key관련 JS -->
	<script src="/javascript/purchase/purchase.js"></script> <!-- purchase 관련 유틸 JS -->
	<script src="https://cdn.iamport.kr/v1/iamport.js"></script><!-- 결제 iamport JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
	<script>
	
      var IMP = window.IMP;
      IMP.init(API_KEYS.imp);
      
      function nomralRequestPay() {
    	  const selectedValue = $('input[name="paymentMethod"]:checked').val();
    	  const pg = getSubscriptionPG(selectedValue);
    	  const currentDate = getCurrentDate();
    	  
          IMP.request_pay({
              pg: selectedValue == 1 ? 'html5_inicis.INIpayTest' : getPaymentMethod(selectedValue),
              pay_method: getPaymentMethod(selectedValue),
              merchant_uid: "purchase_"+'[[${userId}]]'+"_"+currentDate,   // 주문번호
              name: '[[${product.productTitle}]]',
              amount: [[${product.price}]],              // 숫자 타입
              buyer_email: "",
              m_redirect_url: "https://mapmory.co.kr/purchase/orderCompleteMobile/"+[[${product.productNo}]]
              /* m_redirect_url: "http://192.168.0.228:8000/purchase/addPurchase/"+[[${product.productNo}]] */
          },
          function (rsp) {
          	console.log(rsp);
          	
              if(rsp.success){ //빌링키 발급 성공
              	$.ajax({
      				url: "/purchase/addPurchase/"+[[${product.productNo}]] + 
      				"?imp_uid="+rsp.imp_uid + "&merchant_uid"+ rsp.merchant_uid + "&imp_success="+rsp.success,// 요청을 보낼 URL을 입력
      				contentType: 'application/json', // Content-Type을 JSON으로 설정
      				method: 'GET',
      				success: function(response) {
      					console.log(response);

                      	alert("상품 결제 성공!");
                      	
      					window.location.href="/purchase/getPurchaseList";
      				}, // success
      				error: function(error) {
      					console.log('ajax 에러 발생:', error);
          				alert('상품 결제 실패! 다시 시도해주세요!');
      				} // error
      			}); //기록 검색 ajax
  			} else { //빌링키 발급 실패한 경우
  				alert('상품 결제 실패! 다시 시도해주세요!');
  			}//if~else end
  		});//callback rsp
      } //nomralRequestPay
      
      function monthlyRequestPay() {
    	  const selectedValue = $('input[name="paymentMethod"]:checked').val();
    	  const pg = getSubscriptionPG(selectedValue);
    	  const currentDate = getCurrentDate();
    	  
          // IMP.request_pay(param, callback) 호출
          IMP.request_pay(
            {
              pg: pg,
              merchant_uid: "subscription_"+'[[${userId}]]'+"_"+currentDate, // 빌링키 발급용 주문번호
              customer_uid: '[[${userId}]]', // 카드(빌링키)와 1:1로 대응하는 값
              name: '[[${product.productTitle}]]',
              amount: [[${product.price}]], // 0으로 설정하면 빌링키만 발급
              m_redirect_url: "https://mapmory.co.kr/purchase/addSubscription/"+[[${product.productNo}]]
              /* m_redirect_url: "http://192.168.0.228:8000/purchase/addSubscription/"+[[${product.productNo}]] */
            },//빌링키 요청

            function (rsp) {
            	console.log(rsp);
            	
                if(rsp.success){ //빌링키 발급 성공
                	$.ajax({
        				url: "/purchase/addSubscription/"+[[${product.productNo}]] + 
        				"?imp_uid="+rsp.imp_uid + "&merchant_uid"+ rsp.merchant_uid + "&imp_success="+rsp.success,// 요청을 보낼 URL을 입력
        				contentType: 'application/json', // Content-Type을 JSON으로 설정
        				method: 'GET',
        				success: function(response) {
        					console.log(response);

                        	alert("구독 결제 성공!");
                        	
        					window.location.href="/purchase/getDetailSubscription";
        				}, // success
        				error: function(error) {
        					console.log('ajax 에러 발생:', error);
            				alert('구독 결제 중 에러가 발생! 다시 시도해주세요!');
        				} // error
        			}); //기록 검색 ajax
    			} else { //빌링키 발급 실패한 경우
    				alert('구독 결제 중 에러가 발생! 다시 시도해주세요!');
    			}//if~else end
    		});//callback rsp
            	
          } //monthlyRequestPay: 정기결제
		
      </script>
</head>
<body>
	
	<div id=content-for-footer>
		<div th:if="${message != null}" class="text-center full-height d-flex align-items-center justify-content-center">
			<div>
				<h1>현재 구독 중입니다!</h1>
				
				<p>
					<a href="/purchase/getDetailSubscription" class="btn btn-primary">내 구독으로 가기</a>
				</p>
			
			</div>
		</div><!-- 사용자가 현재 구독 중인 경우 나오는 div -->
	
	<div class="container mt-3" th:if="${message == null}">
		<h1 class="fs-1 fw-bold text-center">결제하기</h1>
		
		<form>
			<fieldset>
					<div class="row mb-3 align-items-center border-bottom">
						<label for="productTitle" class="col-4 col-form-label fs-1 fw-bold ">상품명</label>
						<div class="col-8">
							<input type="text" readonly="" class="form-control-plaintext fs-1" 
							id="productTitle" th:value="${product.productTitle}">
						</div>
					</div>

					<div class="row mb-3 align-items-center border-bottom">
						<label for="price" class="col-4 col-form-label fs-1 fw-bold">가격</label>
						<div class="col-custom col-8">
							<input type="text" readonly="" class="form-control-plaintext fs-1"
								id="price" th:value="|${#numbers.formatInteger(product.price, 0, 'COMMA')}원|" />
						</div>
					</div>
					
					<h2 class="fs-1 fw-bold mb-5">결제 수단</h2>
					
					<fieldset>
						<div class="form-check mb-5">
							<input class="form-check-input" type="radio" name="paymentMethod" id="card" value="1">
							<label class="form-check-label" for="card"> <img src="/purchase/image/card.png" alt="카드결제" /> </label>
						</div>

						<div class="form-check mb-5">
							<input class="form-check-input" type="radio" name="paymentMethod" id="kakaopay" value="2">
							<label class="form-check-label" for="kakaopay"> <img src="/purchase/image/kakaopay.png" alt="카카오페이" /> </label>
						</div>

						<div class="form-check mb-5">
							<input class="form-check-input" type="radio" name="paymentMethod" id="payco" value="3">
							<label class="form-check-label" for="payco"> <img src="/purchase/image/payco.png" alt="페이코" /> </label>
						</div>
						
						<div class="form-check mb-5" th:if="${product.period == 0}">
							<input class="form-check-input" type="radio" name="paymentMethod" id="tosspay" value="4">
							<label class="form-check-label" for="tosspay"> <img src="/purchase/image/tosspay.png" alt='토스페이'/> </label>
						</div>
					</fieldset>
			</fieldset>
		</form>
		
		<div th:if="${product.period == 0}" class="d-grid">
			<button class="btn change-color fs-1" onclick="nomralRequestPay()">결제</button>
		</div>
    	
    	<div th:if="${product.period == 30}" class="d-grid">
    		<button class="btn change-color fs-1" onclick="monthlyRequestPay()">구독결제</button>
		</div>
	</div>
	</div>
	
	<div th:replace="common/footer::defaultFooter"></div>
</body>	
</html>